<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clicklife Alert Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Tahoma', Arial, sans-serif; }
        .container { max-width: 500px; margin: 30px auto; padding: 24px; background: #f7f7fa; border-radius: 10px; box-shadow: 0 2px 12px #0001;}
        textarea, select, input { width: 100%; margin-bottom: 12px; padding: 8px; border-radius: 6px; border: 1px solid #d5d5e5;}
        #alertOutput {height: 130px;}
        .hidden {display: none;}
        .status { font-size: 1rem; margin: 5px 0 15px 0;}
    </style>
</head>
<body>
<div class="container">
    <h2>ðŸš— Clicklife - Alert Generator</h2>
    <input type="file" id="fileInput" accept=".xlsx,.csv" />
    <button id="resetData" class="hidden">Change Data File</button>
    <div class="status" id="status" style="color:#007bff;">Data not loaded yet</div>
    <label>ðŸ“„ Tracking Data:</label>
    <textarea id="trackingData" placeholder="Paste tracking data here"></textarea>
    <label>ðŸš¨ Alert Type:</label>
    <select id="alertType">
        <option value="">-- Select Alert Type --</option>
        <option value="towing">Towing</option>
        <option value="external battery disconnected">External Battery Disconnected</option>
        <option value="overspeed">Overspeed</option>
        <option value="stop for 10 day">Stop for 10 Day</option>
        <option value="stop in geofence">Stop in Geofence</option>
    </select>
    <button id="generateAlert">âœ¨ Generate Alert</button>
    <button id="copyAlert" class="hidden">ðŸ“‹ Copy Alert</button>
    <label>ðŸ“¢ Final Alert:</label>
    <textarea id="alertOutput" readonly></textarea>
</div>
<script>
// ØªØ·Ø¨ÙŠØ¹ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø§Ù„Ø±Ù…ÙˆØ² ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª)
function normalizePlate(plate) {
    return String(plate)
        .replace(/[\s\-\*,.\/\\\u200E\u200F]+/g, '')
        .replace(/[^\w\d]/g, '') // remove any non-alphanumeric
        .toLowerCase().trim();
}

function showStatus(msg, color) {
    let status = document.getElementById("status");
    status.textContent = msg;
    status.style.color = color;
}

function saveVehicleDataToStorage(data) {
    localStorage.setItem("vehicleDataClicklife", JSON.stringify(data));
}
function loadVehicleDataFromStorage() {
    let data = localStorage.getItem("vehicleDataClicklife");
    return data ? JSON.parse(data) : null;
}
function clearVehicleDataStorage() {
    localStorage.removeItem("vehicleDataClicklife");
}
function hideUploadSection() {
    document.getElementById("fileInput").classList.add("hidden");
    document.getElementById("resetData").classList.remove("hidden");
}
function showUploadSection() {
    document.getElementById("fileInput").classList.remove("hidden");
    document.getElementById("resetData").classList.add("hidden");
}

function detectCol(headers, keys) {
    for (let h of headers) {
        let clean = h.trim().toLowerCase();
        for (let key of keys) if (clean.includes(key)) return h;
    }
    return null;
}

let vehicleData = {};

document.getElementById("fileInput").addEventListener("change", function(e) {
    let file = e.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
        vehicleData = {};
        let isCSV = file.name.endsWith('.csv');
        if (isCSV) {
            let lines = e.target.result.split(/\r?\n/).filter(l => l.trim()!=="");
            let headers = lines[0].split(',').map(h=>h.trim());
            let vehicleCol = detectCol(headers, ["vehicle","Ø±Ù‚Ù…","plate"]);
            let clientCol = detectCol(headers, ["client","Ø§Ø³Ù…","company"]);
            if (!vehicleCol || !clientCol) {
                showStatus("âš  File must have columns for Vehicle & Client.", "#e25a5a"); return;
            }
            let vIdx = headers.indexOf(vehicleCol), cIdx = headers.indexOf(clientCol);
            for(let i=1;i<lines.length;i++) {
                let cols = lines[i].split(',');
                let v = cols[vIdx]||""; let c=cols[cIdx]||"";
                if (v && c) vehicleData[normalizePlate(v)] = String(c).trim();
            }
        } else {
            let bytes = new Uint8Array(e.target.result);
            let workbook = XLSX.read(bytes, {type:"array"});
            let sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval:""});
            if (!sheet.length) { showStatus("âš  File is empty.", "#e25a5a"); return;}
            let headers = Object.keys(sheet[0]);
            let vehicleCol = detectCol(headers, ["vehicle","Ø±Ù‚Ù…","plate"]);
            let clientCol = detectCol(headers, ["client","Ø§Ø³Ù…","company"]);
            if (!vehicleCol || !clientCol) {
                showStatus("âš  Sheet must have columns for Vehicle & Client.", "#e25a5a"); return;
            }
            for (let row of sheet) {
                let v = row[vehicleCol]||""; let c = row[clientCol]||"";
                if (v && c) vehicleData[normalizePlate(v)] = String(c).trim();
            }
        }
        saveVehicleDataToStorage(vehicleData);
        hideUploadSection();
        showStatus("âœ… Data loaded and saved! ("+Object.keys(vehicleData).length+" vehicles)", "#38b53f");
    };
    if (file.name.endsWith('.csv')) reader.readAsText(file);
    else reader.readAsArrayBuffer(file);
});

document.getElementById("resetData").addEventListener("click", function() {
    clearVehicleDataStorage(); vehicleData = {};
    showUploadSection(); showStatus("Data not loaded yet", "#007bff");
});

window.onload = function() {
    let data = loadVehicleDataFromStorage();
    if (data) { vehicleData = data; hideUploadSection(); }
};

document.getElementById("generateAlert").addEventListener("click", function() {
    let trackingText = document.getElementById("trackingData").value;
    let alertType = document.getElementById("alertType").value;
    if (!trackingText || !alertType) {
        showStatus("âš  Please enter tracking data and select alert type.", "#e25a5a"); return;
    }
    // Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø© Ù‚Ø¨Ù„ Address
    const addressIdx = trackingText.indexOf("Address:");
    let vehicleLine = "";
    if (addressIdx !== -1) vehicleLine = trackingText.substring(0, addressIdx).replace(/\n/g,"").trim();
    else { showStatus("Could not find 'Address:' in tracking data!", "#e25a5a"); return; }
    let plateMatch = vehicleLine.match(/^[^\s]+/); // Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø©
    let plate = plateMatch ? plateMatch[0] : vehicleLine.split(/\s+/)[0] || "";
    let modelColor = vehicleLine.replace(plate, '').trim();
    let plateNorm = normalizePlate(plate);
    // Ø¹Ù†ÙˆØ§Ù†
    let addressMatch = trackingText.match(/Address:\s*(.+)/);
    let address = addressMatch ? addressMatch[1].trim() : "";
    // Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª
    let latMatch = trackingText.match(/Latitude:\s*([0-9\.\-]+)/);
    let lngMatch = trackingText.match(/Longitude:\s*([0-9\.\-]+)/);
    let latitude = latMatch ? latMatch[1] : "";
    let longitude = lngMatch ? lngMatch[1] : "";
    // Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©
    let data = loadVehicleDataFromStorage() || {};
    // Ø¯ÙŠØ¨Ø§Ø¬ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    console.log('Normalized Plate:', plateNorm, 'Found:', !!data[plateNorm], 'vehicleData:', data);
    let clientName = data[plateNorm] || "UNKNOWN COMPANY";
    // Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    let line1 = `Hello, your vehicle has an event,`;
    let vehicleDesc = clientName + ' ' + plate + (modelColor ? ' ' + modelColor : '');
    let typeText = '';
    switch (alertType) {
        case "towing": typeText = "is on recovery"; break;
        case "external battery disconnected": typeText = "has external battery disconnected"; break;
        case "overspeed": typeText = "is overspeeding"; break;
        case "stop for 10 day": typeText = "has stopped for 10 days"; break;
        case "stop in geofence": typeText = "has stopped in geofence"; break;
        default: typeText = "has an event";
    }
    let line2 = `${vehicleDesc} ${typeText} (${address})`;
    let line3 = (latitude && longitude) ? `https://www.google.com/maps?q=${latitude},${longitude}&t=m&hl=en` : '';
    let line4 = `\nClicklife GPS System`;
    let alertMsg = [line1, line2, line3, line4].filter(l => l).join('\n\n');
    document.getElementById("alertOutput").value = alertMsg;
    document.getElementById("copyAlert").classList.remove("hidden");
    showStatus("âœ… Alert generated!", "#38b53f");
});

document.getElementById("copyAlert").addEventListener("click", function() {
    let output = document.getElementById("alertOutput");
    output.select(); document.execCommand("copy");
    showStatus("âœ… Alert copied!", "#3556e4");
});
</script>
</body>
</html>
