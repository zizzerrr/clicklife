<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Vehicle Alert | Clicklife GPS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Excel & SheetJS Parser CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family:'Rubik', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #12243B;
      overflow-y: auto;
      position: relative;
    }
    .bg-video {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      object-fit: cover; z-index: -2;
    }
    .overlay {
      position: fixed; top:0; left:0; width:100vw; height:100vh; 
      background: rgba(18, 36, 59, 0.68);
      z-index:-1;
    }
    .container {
      background:rgba(24,37,64,0.92);
      padding:22px 14px 18px 14px;
      margin-top:32px;
      border-radius:14px;
      box-shadow:0 8px 36px 0 #162f50a8;
      width:95%; max-width:440px;
      display: flex; flex-direction: column; align-items: center;
    }
    h2 { margin: 0 0 12px 0; color:#27a1ff; font-size:2rem;}
    .subtitle {margin-bottom:18px;color:#e9ecef;font-size:1.08rem;}
    label {color:#b8d6ff;font-size:1.01rem; margin-top:13px;}
    .hint {color:#7cb9fa; font-size:0.9rem;}
    textarea, select, input[type="file"] {
      width:100%; margin-top:5px; margin-bottom:6px;
      border-radius:7px; border:1.2px solid #1864bf56;
      font-size:1rem; padding:7px; background:#182540; color:#e9edff;
      font-family:'Rubik', Arial, sans-serif;
      resize: vertical;
    }
    #alertOutput { min-height:80px;}
    #copyBtn {margin-left:0;margin-top:5px;}
    button {
      margin:10px 0 0 0; background:#2366b1;color:#fff;
      border:none; border-radius:9px;padding:9px 20px;
      font-size:1.09rem; font-family:'Rubik', Arial, sans-serif;
      cursor:pointer; font-weight:500;
      box-shadow:0 2px 18px -8px #27a1ff;
    }
    button:active {background:#1c5394;}
    #companyName {
      display: none;
      font-size:1.09rem;
      margin-bottom:7px;
      color:#e7e8fc;
      background:rgba(35,132,235,0.13);
      padding:4px 12px;
      border-radius:7px;
      font-weight:700;
    }
    .resultRow {width:100%; margin-top:14px;}
    @media (max-width:600px) {
      .container {max-width:100%; width:98%;}
      h2 {font-size:1.24rem;}
    }
  </style>
</head>
<body>
  <!-- GPS/Map video background -->
  <video class="bg-video" autoplay loop muted playsinline>
    <source src="https://assets.mixkit.co/videos/preview/mixkit-navigation-map-on-a-gps-2187-large.mp4" type="video/mp4">
    <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=900&q=80" alt="gps background">
  </video>
  <div class="overlay"></div>

  <div class="container">
    <h2>Clicklife GPS Alert</h2>
    <div class="subtitle">Generate a professional vehicle alert in seconds.</div>

    <!-- Excel Upload Field -->
    <label for="excelUpload">Upload Excel File (Vehicle & Client):</label>
    <input type="file" id="excelUpload" accept=".xls,.xlsx">
    <span class="hint">قم برفع ملف إكسل يحتوي على رقم العربية واسم الشركة في عمودَي Vehicle و Client</span>
    <div id="companyName"></div>

    <label for="trackingData">Tracking Data:</label>
    <span class="hint">قم بلصق بيانات تتبع العربية من النظام هنا.</span>
    <textarea id="trackingData" placeholder="Example:&#10;657014 Changan&#10;Address: New Industrial, Ajman, UAE&#10;Speed: 105 kph"></textarea>
    <label for="alertType">Alert Type:</label>
    <select id="alertType">
      <option value="">-- Select alert type --</option>
      <option value="towing">Towing</option>
      <option value="external battery disconnected">External Battery Disconnected</option>
      <option value="overspeed">Overspeed</option>
      <option value="stop for 10 day">Stop for 10 Day</option>
      <option value="stop in geofence">Stop in Geofence</option>
    </select>
    <button onclick="generateAlert()"><i class="fa-solid fa-bolt"></i> Generate Alert</button>
    <button onclick="copyAlert()" id="copyBtn" style="display:none;"><i class="fa-solid fa-copy"></i> Copy Alert</button>
    <div class="resultRow">
      <label for="alertOutput">Result:</label>
      <textarea id="alertOutput" readonly></textarea>
    </div>
  </div>
<script>
// تخزين معلومات الإكسل (Vehicle: Client)
let excelData = {};

document.getElementById('excelUpload').addEventListener('change', function(evt){
  let file = evt.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(e){
    let data = new Uint8Array(e.target.result);
    let workbook = XLSX.read(data, {type: 'array'});
    let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    let sheetJson = XLSX.utils.sheet_to_json(firstSheet, {header:1});
    // توقع أن أول صف هو العناوين: [Vehicle, Client]
    let vehicleIdx = -1, clientIdx = -1;
    if (!sheetJson.length) return alert("Empty Excel file");
    // البحث عن الأعمدة بالعناوين Vehicle وClient
    sheetJson[0].forEach((col, idx)=>{
      if(typeof col === 'string') {
        if(col.trim().toLowerCase().includes('vehicle')) vehicleIdx = idx;
        if(col.trim().toLowerCase().includes('client')) clientIdx = idx;
      }
    });
    if(vehicleIdx === -1 || clientIdx === -1)
      return alert("Excel must have columns 'Vehicle' and 'Client'");
    // بناء قاموس البيانات: مفتاحه الرقم فقط (بدون موديل او لون)
    excelData = {};
    for(let i=1; i<sheetJson.length; ++i){
      let row = sheetJson[i];
      let vehicleFull = (row[vehicleIdx] || '').toString().trim();
      let clientVal = (row[clientIdx] || '').toString().trim() || 'UNKNOWN CLIENT';
      // التقاط الرقم فقط بدون موديل ولون
      let vehicleNum = vehicleFull.match(/^[^\s-]+/) ? vehicleFull.match(/^[^\s-]+/)[0].replace(/\*/g,"").trim() : "";
      if(vehicleNum)
        excelData[vehicleNum.toLowerCase()] = clientVal;
    }
    alert('Excel data loaded: ' + Object.keys(excelData).length + ' vehicle(s)');
  };
  reader.readAsArrayBuffer(file);
});

function getPlate(tracking) {
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let plateMatch = vehicleLine.match(/^[^\s-]*/);
    let plate = plateMatch ? plateMatch[0].replace(/\*/g,"") : vehicleLine.split(/\s+/)[0] || "";
    return plate.trim();
}

// استخراج اسم العميل (الشركة) حسب الرقم فقط
function getCompany(plate) {
    let normalizedPlate = plate.trim().toLowerCase();
    if(excelData.hasOwnProperty(normalizedPlate)) return excelData[normalizedPlate];
    // ابحث بغض النظر عن النجوم او الرموز
    for (let key in excelData) {
      if (key.replace(/\*/g,"").toLowerCase() === normalizedPlate) return excelData[key];
    }
    return 'UNKNOWN CLIENT';
}

function generateAlert() {
    let tracking = document.getElementById('trackingData').value;
    let alertType = document.getElementById('alertType').value;
    if (!tracking || !alertType) { alert('Please enter tracking data and select alert type.'); return; }
    // استخراج رقم العربية
    let plate = getPlate(tracking);
    // استخراج اسم العميل من الاكسل (او UNKNOWN CLIENT)
    let companyName = getCompany(plate);

    // استخراج موديل/لون
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let modelColor = vehicleLine.replace(plate, '').trim();

    // استخراج العنوان
    let addressMatch = tracking.match(/Address:\s*(.+)/);
    let address = addressMatch ? addressMatch[1].trim() : "";

    // استخراج خطوط العرض والطول
    let latMatch = tracking.match(/Latitude:\s*([0-9\.\-]+)/);
    let lngMatch = tracking.match(/Longitude:\s*([0-9\.\-]+)/);
    let latitude = latMatch ? latMatch[1] : "";
    let longitude = lngMatch ? lngMatch[1] : "";

    // استخراج السرعة إذا كانت نوع التنبيه overspeed
    let typeText = "";
    if(alertType === "overspeed") {
        let speedMatch = tracking.match(/Speed:\s*([0-9\.]+)\s*kph?/i);
        let speed = speedMatch ? speedMatch[1] : "";
        typeText = speed ? `was speeding ${speed} kph` : "was speeding";
    } else {
        switch (alertType) {
            case "towing": typeText = "was on recovery"; break;
            case "external battery disconnected": typeText = "had the external battery disconnected"; break;
            case "stop for 10 day": typeText = "has stopped for 10 days"; break;
            case "stop in geofence": typeText = "has stopped in geofence"; break;
            default: typeText = "had an event";
        }
    }

    // بناء وصف العربية
    let vehicleDesc = `${companyName} ${plate} ${modelColor}`.replace(/\s+/g, ' ').trim();

    // الرسالة بالنموذج الجديد
    let msg = [
        `Hello, your vehicle has an event,`,
        `${vehicleDesc} ${typeText} (${address})`,
        (latitude && longitude) ? `https://www.google.com/maps?q=${latitude},${longitude}&t=m&hl=en` : '',
        "Clicklife GPS System"
    ].filter(Boolean).join('\n\n');
    document.getElementById('alertOutput').value = msg;

    // إظهار اسم الشركة (العميل) على الصفحة
    let companyField = document.getElementById('companyName');
    companyField.innerHTML = 'Client: <b>' + companyName + '</b>';
    companyField.style.display = 'block';

    document.getElementById('copyBtn').style.display = 'inline-block';
}

function copyAlert() {
    let output = document.getElementById('alertOutput');
    output.select();
    document.execCommand("copy");
    document.getElementById('copyBtn').textContent = "✅ Copied!";
    setTimeout(()=>{document.getElementById('copyBtn').innerHTML = '<i class=\"fa-solid fa-copy\"></i> Copy Alert';}, 1200);
}
</script>
</body>
</html>
