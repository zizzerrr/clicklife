<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Vehicle Alert | Clicklife GPS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(135deg, #22293b 30%, #373e4c 100%);
      color: #f5f6fa;
      overflow-y: auto;
      position: relative;
      transition: background 0.5s;
    }
    .container {
      background: #171c24;
      padding: 28px 24px 24px 24px;
      margin-top: 38px;
      border-radius: 12px;
      box-shadow: 0 2px 18px 0 #22293b70;
      width: 96%;
      max-width: 640px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #252728;
      gap: 0.5rem;
      animation: fadeIn 0.7s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 { 
      margin: 0 0 15px 0; 
      color: #34e4a7; 
      font-size: 2rem; 
      font-weight:700; 
      letter-spacing: 0.5px;
      font-family: 'Segoe UI Semibold', Arial, sans-serif;
      text-shadow: 0 2px 20px #25272833;
    }
    .subtitle {
      margin-bottom: 18px;
      color: #9fcad4;
      font-size: 1.09rem;
      text-align: center;
    }
    label {
      color: #b2fff4;
      font-size:1.08rem; 
      margin-top:18px;
      font-weight: 500;
      letter-spacing: 0.4px;
    }
    .hint {
      color: #62f1d6; 
      font-size:0.96rem;
      margin-bottom: 10px;
      margin-top: 0px;
      padding-bottom: 2px;
      text-align: left;
      width: 100%;
      background: #212a31;
      border-radius: 4px;
      padding: 6px 8px;
    }
    textarea, select, input[type="file"] {
      width: 100%; 
      margin-top:7px; 
      margin-bottom:11px;
      border-radius: 6px; 
      border: 1px solid #314047;
      font-size: 1rem; 
      padding: 9px; 
      background: #212a31; 
      color: #d3e5ed;
      font-family: 'Segoe UI', Arial, sans-serif;
      resize: vertical;
      transition: border .15s;
      box-sizing: border-box;
    }
    textarea:focus, select:focus, input[type="file"]:focus { 
      outline: none; 
      border: 1.5px solid #3eeec5;
      background: #1c2531;
    }
    #alertOutput { min-height: 90px; background: #181c20; border: 1px solid #314047;}
    #alertOutputHtml {
      width: 100%;
      min-height: 90px;
      margin-top: 7px;
      margin-bottom: 11px;
      border-radius: 6px;
      border: 1px solid #314047;
      font-size: 1rem;
      padding: 9px;
      background: #212a31;
      color: #d3e5ed;
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
      white-space: pre-wrap;
      display: none;
    }
    #mapContainer {
      width: 100%;
      margin-top: 10px;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    #mapContainer a { text-decoration: none; width:100%; display:flex; flex-direction:column; align-items:center; gap:8px; }
    #mapContainer img {
      max-width: 100%;
      border-radius: 6px;
      border: 1px solid #314047;
      background: #111;
    }
    .mapCaption {
      background: #212a31;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #283741;
      color: #dff8ee;
      font-weight: 700;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      direction: ltr;
    }
    #copyBtn {margin-top:10px;}
    button {
      margin: 13px 6px 0 6px; 
      background: linear-gradient(92deg,#34e4a7 32%,#177d70 96%);
      color: #171c22;
      border: none; 
      border-radius: 8px; 
      padding: 10px 20px;
      font-size: 1.08rem;
      font-family: 'Segoe UI', Arial, sans-serif;
      cursor: pointer;
      font-weight:600;
      letter-spacing: 0.2px;
      box-shadow: 0 2px 8px #29ca8e35;
      transition: background .2s, transform .1s;
    }
    button:active, button:focus {background:linear-gradient(92deg,#52ffd4 42%,#29b19c 100%); transform:scale(0.98)}
    #companyName {
      display: none;
      font-size:1.09rem;
      margin-bottom:11px;
      color: #f5f6fa;
      background: #212a31;
      padding:7px 16px;
      border-radius:6px;
      font-weight:600;
      border: 1px solid #283741;
      align-self: flex-start;
      letter-spacing: 0.3px;
      margin-top: 0px;
    }
    .resultRow {width:100%; margin-top:18px;}
    #alertOutput {font-size:1rem; font-weight:500;}
    .btnRow { display:flex; gap:6px; justify-content:center; width:100%; flex-wrap:wrap; }
    @media (max-width:700px) {
      .container {max-width:100%; width:99%;}
      h2 {font-size:1.35rem;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Vehicle Alert Generator</h2>
    <div class="subtitle">
      Menna Naeem The accountent is forbidden from using this tool
    </div>
    <label for="txtUpload">Upload TXT File (Vehicle & Client):</label>
    <input type="file" id="txtUpload" accept=".txt">
    <span class="hint">
      Please upload a TXT file with this format:<br>
      <b>No Need "مكسل اشلها"</b><br>
      Then fill every line with a vehicle and client information.<br>
      Example:<br>
      <code>195489 Changan Gray
Address:	Shaikh Isa Bin Salman Highway, Salmabad, Northern Governorate, Bahrain
Street view:	Preview >>
Latitude:	26.1951066°
Longitude:	50.5305516°
Altitude:	9 m
Speed:	155 kph
Time:	2025-11-28 15:16:03
</code>
    </span>
    <div id="companyName"></div>
    <label for="trackingData">Tracking Data:</label>
    <span class="hint">Paste here the direct tracking data for the vehicle from the system.</span>
    <textarea id="trackingData" placeholder="Example:&#10;657014 Changan&#10;Address: New Industrial, Ajman, UAE&#10;Latitude: 25.0000&#10;Longitude: 55.0000&#10;Speed: 105 kph"></textarea>
    <label for="alertType">Alert Type:</label>
    <select id="alertType">
      <option value="">-- Select alert type --</option>
      <option value="towing">Towing</option>
      <option value="external battery disconnected">External Battery Disconnected</option>
      <option value="overspeed">Overspeed</option>
      <option value="stop for 10 day">Stop for 10 Day</option>
      <option value="stop in geofence">Stop in Geofence</option>
    </select>

    <div class="btnRow">
      <button onclick="generateAlert('en')" id="genBtnEn">Generate Alert (English)</button>
      <button onclick="generateAlert('ar')" id="genBtnAr">توليد التنبيه (بالعربية)</button>
      <button onclick="copyAlert()" id="copyBtn" style="display:none;">Copy Alert</button>
    </div>

    <div class="resultRow">
      <label for="alertOutput">Result:</label>
      <textarea id="alertOutput" readonly style="direction:ltr;"></textarea>
      <div id="alertOutputHtml" aria-hidden="false" style="direction:rtl; text-align:right;"></div>

      <div id="mapContainer">
        <a id="mapLink" href="#" target="_blank" rel="noopener noreferrer" title="Open in Google Maps">
          <img id="mapImage" src="" alt="Map snapshot" crossorigin="anonymous">
        </a>
        <div id="mapCaption" class="mapCaption"></div>
      </div>
    </div>
  </div>
<script>
// Store txt info (Vehicle:Client)
let excelData = {};

// Load from LocalStorage if available
if (localStorage.getItem('excelData')) {
    try {
        excelData = JSON.parse(localStorage.getItem('excelData')) || {};
    } catch (e) { excelData = {}; }
}

document.getElementById('txtUpload').addEventListener('change', function(evt){
  const file = evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    const lines = text.split(/\r?\n/);
    excelData = {};
    let headerSkip = false;
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i].trim();
      if (!line) continue;
      if (!headerSkip) {
        if (line.toLowerCase().includes('vehicle') && line.toLowerCase().includes('client')) {
          headerSkip = true;
          continue;
        } else { headerSkip = true; }
      }
      let splitter = (line.indexOf('\t') !== -1) ? '\t' : (line.indexOf(',') !== -1 ? ',' : null);
      let parts = splitter ? line.split(splitter) : line.split(/\s{2,}/);
      let vehicle = (parts[0] || '').replace(/[^A-Za-z0-9]/g, '').replace(/\*/g, "").trim().toLowerCase();
      let client = (parts[1] || '').trim();
      if(vehicle) {
        excelData[vehicle] = client || 'UNKNOWN CLIENT';
        excelData[parts[0].toLowerCase().trim()] = client || 'UNKNOWN CLIENT';
      }
    }
    localStorage.setItem('excelData', JSON.stringify(excelData));
    alert('TXT data loaded: ' + Object.keys(excelData).length + ' vehicle(s)');
  };
  reader.readAsText(file);
});

function getPlate(tracking) {
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let plateMatch = vehicleLine.match(/^(\S+)/);
    let plate = plateMatch ? plateMatch[1].replace(/\*/g,"") : vehicleLine.split(/\s+/)[0] || "";
    return plate.trim();
}

function getCompany(plate, tracking) {
    let normalizedPlate = plate.trim().toLowerCase();
    let cleanPlate = normalizedPlate.replace(/[^A-Za-z0-9]/g, '');
    if(cleanPlate && excelData.hasOwnProperty(cleanPlate)) return excelData[cleanPlate];
    if(normalizedPlate && excelData.hasOwnProperty(normalizedPlate)) return excelData[normalizedPlate];
    let firstLine = tracking.split('\n')[0].trim().toLowerCase();
    if(firstLine && excelData.hasOwnProperty(firstLine)) return excelData[firstLine];
    for (let key in excelData) {
      let keyClean = key.replace(/[^A-Za-z0-9]/g, '');
      if (keyClean && keyClean == cleanPlate) return excelData[key];
    }
    return 'UNKNOWN CLIENT';
}

async function generateAlert(lang='en') {
    let tracking = document.getElementById('trackingData').value;
    let alertType = document.getElementById('alertType').value;
    if (!tracking || !alertType) { alert('Please enter tracking data and select alert type.'); return; }

    let plate = getPlate(tracking);
    let companyName = getCompany(plate, tracking);
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let modelColor = vehicleLine.replace(new RegExp('^' + escapeRegExp(plate)), '').trim();
    modelColor = modelColor.replace(/\s+/g,' ').trim();
    let addressMatch = tracking.match(/Address:\s*(.+)/);
    let address = addressMatch ? addressMatch[1].trim() : "";
    let latMatch = tracking.match(/Latitude:\s*([0-9\.\-]+)/);
    let lngMatch = tracking.match(/Longitude:\s*([0-9\.\-]+)/);
    let latitude = latMatch ? latMatch[1] : "";
    let longitude = lngMatch ? lngMatch[1] : "";

    if (!latitude || !longitude) {
      alert('لا يوجد إحداثيات في بيانات التتبع. لا يمكن إنشاء صورة الخريطة. (Latitude/Longitude مفقودة)');
      document.getElementById('mapContainer').style.display = 'none';
      return;
    }

    // type texts
    let typeTextEn = "";
    if(alertType === "overspeed") {
        let speedMatch = tracking.match(/Speed:\s*([0-9\.]+)\s*kph?/i);
        let speed = speedMatch ? speedMatch[1] : "";
        typeTextEn = speed ? `was speeding ${speed} kph` : "was speeding";
    } else {
        switch (alertType) {
            case "towing": typeTextEn = "was on recovery"; break;
            case "external battery disconnected": typeTextEn = "had the external battery disconnected"; break;
            case "stop for 10 day": typeTextEn = "has stopped for 10 days"; break;
            case "stop in geofence": typeTextEn = "has stopped in geofence"; break;
            default: typeTextEn = "had an event";
        }
    }

    let vehicleDesc = `${companyName} ${plate} ${modelColor}`.replace(/\s+/g, ' ').trim();
    let googleLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
    let msgEn = [
        `Hello, your vehicle has an event,`,
        `${vehicleDesc} ${typeTextEn} (${address})`,
        googleLink,
        "Clicklife GPS System"
    ].filter(Boolean).join('\n\n');

    let typeTextAr = "";
    switch (alertType) {
        case "overspeed":
            let speedM = tracking.match(/Speed:\s*([0-9\.]+)\s*kph?/i);
            typeTextAr = speedM ? `تجاوز السرعة (${speedM[1]} كلم/س)` : "تجاوز السرعة";
            break;
        case "towing": typeTextAr = "سحب/استرداد"; break;
        case "external battery disconnected": typeTextAr = "فصل البطارية"; break;
        case "stop for 10 day": typeTextAr = "توقف لمدة 10 أيام"; break;
        case "stop in geofence": typeTextAr = "توقف داخل منطقة جغرافية"; break;
        default: typeTextAr = "حدث غير محدد";
    }

    let plateAndModel = (plate + (modelColor ? ' ' + modelColor : '')).trim();
    plateAndModel = plateAndModel.replace(/\s+/g, ' ').trim();

    let msgArTextLines = [];
    msgArTextLines.push('مرحبًا،');
    msgArTextLines.push('');
    msgArTextLines.push(`يوجد تنبيه لسيارة رقم ${plateAndModel}، حيث تم تلقي تنبيه بـ${typeTextAr} في:`);
    if(address) msgArTextLines.push(address);
    msgArTextLines.push('');
    msgArTextLines.push('رابط الموقع على الخريطة: ' + googleLink);
    msgArTextLines.push('');
    msgArTextLines.push('فريق عمل كليك لايف جي بي اس');
    let msgArText = msgArTextLines.filter(Boolean).join('\n');

    let msgArHtml = msgArTextLines.map(line=>{
        if(line === 'فريق عمل كليك لايف جي بي اس') return '<b>' + escapeHtml(line) + '</b>';
        if(line.startsWith('رابط الموقع على الخريطة:')) {
            let parts = line.split(': ');
            return escapeHtml(parts[0] + ': ') + `<a href="${googleLink}" target="_blank" style="color:#9feed0">${googleLink}</a>`;
        }
        return escapeHtml(line);
    }).join('<br>');

    // build static map url (OpenStreetMap static)
    const zoom = 16;
    const width = 600;
    const height = 330;
    const mapImageUrl = `https://staticmap.openstreetmap.de/staticmap.php?center=${latitude},${longitude}&zoom=${zoom}&size=${width}x${height}&markers=${latitude},${longitude},red-pushpin`;

    // Update UI header info
    let companyField = document.getElementById('companyName');
    companyField.innerHTML = 'Client: <b>' + escapeHtml(companyName) + '</b>';
    companyField.style.display = 'block';
    document.getElementById('copyBtn').style.display = 'inline-block';

    // Map handling: try to fetch as CORS image first (if server allows). If fetch success -> use blob URL (avoids some hotlink/CORS onerror issues).
    // If fetch fails due to CORS, set image src to raw url (so clicking/opening still works) and rely on onerror fallback to show SVG message.
    let mapContainer = document.getElementById('mapContainer');
    let mapImage = document.getElementById('mapImage');
    let mapLink = document.getElementById('mapLink');
    let mapCaption = document.getElementById('mapCaption');
    mapLink.href = googleLink;
    mapCaption.textContent = plateAndModel;

    // set event handlers (final fallback handled in onerror)
    mapImage.onload = function() {
      mapContainer.style.display = 'flex';
      mapImage.style.cursor = 'pointer';
      mapImage.onclick = function() { window.open(googleLink, '_blank'); };
    };
    mapImage.onerror = function(ev) {
      console.warn('Map image failed to load (img.onerror). Will show fallback that opens Google Maps on click.', ev);
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${width}' height='${height}'><rect fill='#111' width='100%' height='100%'/><text x='50%' y='45%' fill='#fff' font-size='20' text-anchor='middle' dominant-baseline='middle'>صورة الخريطة غير متاحة</text><text x='50%' y='60%' fill='#9feed0' font-size='16' text-anchor='middle' dominant-baseline='middle'>اضغط لفتح الخريطة في جوجل مابس</text></svg>`;
      const dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
      mapImage.src = dataUrl;
      mapImage.style.cursor = 'pointer';
      mapImage.onclick = function() { window.open(googleLink, '_blank'); };
      mapContainer.style.display = 'flex';
    };

    // Start by trying to fetch the image as CORS request so we can get a blob (improves reliability and enables copying the image later where CORS allows).
    // If fetch succeeds we use blob URL; if it fails (CORS or network) we fall back to direct src assignment (click still opens Google Maps).
    try {
      fetch(mapImageUrl, { mode: 'cors' }).then(response => {
        if (response.ok) {
          return response.blob();
        }
        throw new Error('Fetch returned not ok: ' + response.status);
      }).then(blob => {
        const blobUrl = URL.createObjectURL(blob);
        mapImage.src = blobUrl; // this should trigger onload
        // store blob on image element for later copy attempts
        mapImage._fetchedBlob = blob;
      }).catch(err => {
        // likely CORS or other issue — fall back to raw src (image may still load in browser when clicked)
        console.warn('Could not fetch map image as CORS blob, using raw image URL. Error:', err);
        mapImage.src = mapImageUrl;
        // no blob available in this case
        delete mapImage._fetchedBlob;
      });
    } catch (e) {
      console.warn('Exception while fetching map image:', e);
      mapImage.src = mapImageUrl;
      delete mapImage._fetchedBlob;
    }

    // Show text output according to language
    if (lang === 'ar') {
        document.getElementById('alertOutput').style.display = 'none';
        let outHtml = document.getElementById('alertOutputHtml');
        outHtml.style.display = 'block';
        outHtml.innerHTML = msgArHtml;
        document.getElementById('alertOutput').value = msgArText;
    } else {
        document.getElementById('alertOutputHtml').style.display = 'none';
        let out = document.getElementById('alertOutput');
        out.style.display = 'block';
        out.value = msgEn;
        document.getElementById('alertOutputHtml').innerHTML = '';
    }
}

// Copy function: attempts to copy image + text when browser supports ClipboardItem and we have a blob.
// If not possible (CORS/no support), falls back to copying text only (and includes google link).
async function copyAlert() {
    const outTextarea = document.getElementById('alertOutput');
    const outHtml = document.getElementById('alertOutputHtml');
    const mapImage = document.getElementById('mapImage');
    const mapLinkElem = document.getElementById('mapLink');
    const googleLink = mapLinkElem && mapLinkElem.href ? mapLinkElem.href : '';

    let textToCopy = '';
    if (outHtml.style.display === 'block') {
        textToCopy = outTextarea.value || outHtml.textContent || outHtml.innerText || '';
    } else {
        textToCopy = outTextarea.value || '';
    }
    if (googleLink && !textToCopy.includes('google.com/maps')) {
        // append google link in Arabic label so WhatsApp recipients see it
        if (textToCopy.includes('رابط الموقع على الخريطة') || textToCopy.includes('Google Maps') || textToCopy.includes('maps')) {
          // already contains link label
        } else {
          textToCopy += '\n\nرابط الموقع على الخريطة: ' + googleLink;
        }
    }

    // Try to copy image + text (only possible if we have blob and browser supports ClipboardItem)
    if (navigator.clipboard && window.ClipboardItem) {
      try {
        // prefer blob stored during fetch (mapImage._fetchedBlob). If not present try to fetch with CORS (may fail).
        let imageBlob = mapImage && mapImage._fetchedBlob ? mapImage._fetchedBlob : null;
        if (!imageBlob && mapImage && mapImage.src && !mapImage.src.startsWith('data:')) {
          // try to fetch as CORS to get blob
          try {
            const resp = await fetch(mapImage.src, { mode: 'cors' });
            if (resp.ok) {
              imageBlob = await resp.blob();
            }
          } catch (e) {
            // fetch failed (likely CORS) -> imageBlob stays null
            console.warn('Fetching map image for clipboard failed (likely CORS).', e);
          }
        } else if (mapImage && mapImage.src && mapImage.src.startsWith('data:')) {
          // convert data URL to blob
          imageBlob = dataURLtoBlob(mapImage.src);
        }

        if (imageBlob) {
          // create ClipboardItem with both image and text (text as plain)
          const items = {};
          // ensure image mime type, default to image/png
          const type = imageBlob.type || 'image/png';
          items[type] = imageBlob;
          // add text/plain via Blob
          items['text/plain'] = new Blob([textToCopy], { type: 'text/plain' });

          const clipboardItem = new ClipboardItem(items);
          await navigator.clipboard.write([clipboardItem]);
          flashCopyBtn();
          return;
        }
      } catch (err) {
        console.warn('Copying image+text to clipboard failed:', err);
        // fall through to text-only fallback
      }
    }

    // Fallback: copy text only
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(textToCopy).then(()=>{ flashCopyBtn(); }, ()=>{ fallbackCopyText(textToCopy); });
    } else {
      fallbackCopyText(textToCopy);
    }
}

// helpers
function dataURLtoBlob(dataurl) {
  const arr = dataurl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--) { u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], {type:mime});
}

function fallbackCopyText(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try {
        document.execCommand('copy');
        document.body.removeChild(ta);
        flashCopyBtn();
    } catch (e) {
        document.body.removeChild(ta);
        alert('Copy failed');
    }
}

function flashCopyBtn() {
    const btn = document.getElementById('copyBtn');
    const old = btn.textContent;
    btn.textContent = "Copied!";
    setTimeout(()=>{ btn.textContent = old; }, 1100);
}

function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function escapeHtml(unsafe) { return (unsafe+'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
</script>
</body>
</html>
