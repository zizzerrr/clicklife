<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Vehicle Alert | Clicklife GPS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Google Fonts: Removed, use Arial -->
  <!-- Icons: Removed -->
  <!-- Excel & SheetJS Parser CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif !important;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f5f6fa;
      color: #1e1e1e;
      overflow-y: auto;
      position: relative;
    }
    .container {
      background: #ffffff;
      padding: 22px 14px 18px 14px;
      margin-top: 32px;
      border-radius: 8px;
      box-shadow: 0 2px 14px 0 #e4e7ed;
      width: 95%;
      max-width: 440px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #e4e7ed;
    }
    h2 { margin: 0 0 12px 0; color: #23344d; font-size: 1.7rem; font-weight:700;}
    .subtitle {margin-bottom:18px;color: #575757;font-size:1.07rem;}
    label {color: #1f1f1f;font-size:1.01rem; margin-top:13px;}
    .hint {color: #555; font-size:0.93rem;}
    textarea, select, input[type="file"] {
      width: 100%; margin-top:5px; margin-bottom:6px;
      border-radius: 5px; border: 1px solid #cdd1d5;
      font-size: 1rem; padding: 7px; background: #f8f9fa; color: #1e1e1e;
      font-family: Arial, sans-serif;
      resize: vertical;
    }
    #alertOutput { min-height:80px;}
    #copyBtn {margin-left:0;margin-top:5px;}
    button {
      margin: 10px 0 0 0; background: #2d2d2d;color: #fff;
      border: none; border-radius: 7px; padding: 8px 16px;
      font-size: 1.04rem; font-family: Arial, sans-serif;
      cursor: pointer; font-weight:500;
      box-shadow: none;
    }
    button:active {background:#444;}
    #companyName {
      display: none;
      font-size:1.06rem;
      margin-bottom:7px;
      color:#1e1e1e;
      background: #f0f0f0;
      padding:4px 12px;
      border-radius:5px;
      font-weight:600;
      border: 1px solid #e3e3e3;
    }
    .resultRow {width:100%; margin-top:14px;}
    @media (max-width:600px) {
      .container {max-width:100%; width:98%;}
      h2 {font-size:1.19rem;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Clicklife GPS Alert</h2>
    <div class="subtitle">Generate a professional vehicle alert message.</div>
    <!-- Excel Upload Field -->
    <label for="excelUpload">Upload Excel File (Vehicle & Client):</label>
    <input type="file" id="excelUpload" accept=".xls,.xlsx">
    <span class="hint">قم برفع ملف إكسل يحتوي على رقم العربية واسم الشركة في عمودَي Vehicle و Client</span>
    <div id="companyName"></div>
    <label for="trackingData">Tracking Data:</label>
    <span class="hint">قم بلصق بيانات تتبع العربية من النظام هنا.</span>
    <textarea id="trackingData" placeholder="Example:&#10;657014 Changan&#10;Address: New Industrial, Ajman, UAE&#10;Speed: 105 kph"></textarea>
    <label for="alertType">Alert Type:</label>
    <select id="alertType">
      <option value="">-- Select alert type --</option>
      <option value="towing">Towing</option>
      <option value="external battery disconnected">External Battery Disconnected</option>
      <option value="overspeed">Overspeed</option>
      <option value="stop for 10 day">Stop for 10 Day</option>
      <option value="stop in geofence">Stop in Geofence</option>
    </select>
    <button onclick="generateAlert()" id="genBtn">Generate Alert</button>
    <button onclick="copyAlert()" id="copyBtn" style="display:none;">Copy Alert</button>
    <div class="resultRow">
      <label for="alertOutput">Result:</label>
      <textarea id="alertOutput" readonly></textarea>
    </div>
  </div>
<script>
// تخزين معلومات الإكسل (Vehicle: Client)
let excelData = {};

// تحميل من LocalStorage لو متخزن من قبل
if (localStorage.getItem('excelData')) {
    try {
        excelData = JSON.parse(localStorage.getItem('excelData')) || {};
    } catch (e) { excelData = {}; }
}

document.getElementById('excelUpload').addEventListener('change', function(evt){
  let file = evt.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(e){
    let data = new Uint8Array(e.target.result);
    let workbook = XLSX.read(data, {type: 'array'});
    let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    let sheetJson = XLSX.utils.sheet_to_json(firstSheet, {header:1});
    // توقع أن أول صف هو العناوين: [Vehicle, Client]
    let vehicleIdx = -1, clientIdx = -1;
    if (!sheetJson.length) return alert("Empty Excel file");
    sheetJson[0].forEach((col, idx)=>{
      if(typeof col === 'string') {
        if(col.trim().toLowerCase().includes('vehicle')) vehicleIdx = idx;
        if(col.trim().toLowerCase().includes('client')) clientIdx = idx;
      }
    });
    if(vehicleIdx === -1 || clientIdx === -1)
      return alert("Excel must have columns 'Vehicle' and 'Client'");
    // بناء قاموس البيانات: مفتاحه الرقم مع مرونة إضافية
    excelData = {};
    for(let i=1; i<sheetJson.length; ++i){
      let row = sheetJson[i];
      let vehicleFull = (row[vehicleIdx] || '').toString().trim();
      let clientVal = (row[clientIdx] || '').toString().trim() || 'UNKNOWN CLIENT';
      // استخراج الرقم بدون نجوم/رموز
      let cleanNum = vehicleFull.replace(/[^A-Za-z0-9]/g, '').replace(/\*/g,"").toLowerCase();
      // أيضا أضف كامل السطر لمرونة أكبر
      if(cleanNum) excelData[cleanNum] = clientVal;
      if(vehicleFull) excelData[vehicleFull.trim().toLowerCase()] = clientVal;
    }
    localStorage.setItem('excelData', JSON.stringify(excelData)); // حفظ البيانات
    alert('Excel data loaded: ' + Object.keys(excelData).length + ' vehicle(s)');
  };
  reader.readAsArrayBuffer(file);
});

function getPlate(tracking) {
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let plateMatch = vehicleLine.match(/^[^\s-]*/);
    let plate = plateMatch ? plateMatch[0].replace(/\*/g,"") : vehicleLine.split(/\s+/)[0] || "";
    return plate.trim();
}

// تحسين دالة استخراج العميل
function getCompany(plate, tracking) {
    let normalizedPlate = plate.trim().toLowerCase();
    let cleanPlate = normalizedPlate.replace(/[^A-Za-z0-9]/g, '');
    // محاولات مرنة للبحث
    if(excelData.hasOwnProperty(cleanPlate)) return excelData[cleanPlate];
    if(excelData.hasOwnProperty(normalizedPlate)) return excelData[normalizedPlate];
    // جرب كامل سطر تتبع السيارة
    let firstLine = tracking.split('\n')[0].trim().toLowerCase();
    if(excelData.hasOwnProperty(firstLine)) return excelData[firstLine];
    // ابحث بغض النظر عن * والرموز والمسافات
    for (let key in excelData) {
      let keyClean = key.replace(/[^A-Za-z0-9]/g, '');
      if (keyClean == cleanPlate) return excelData[key];
    }
    return 'UNKNOWN CLIENT';
}

function generateAlert() {
    let tracking = document.getElementById('trackingData').value;
    let alertType = document.getElementById('alertType').value;
    if (!tracking || !alertType) { alert('Please enter tracking data and select alert type.'); return; }
    // استخراج رقم العربية
    let plate = getPlate(tracking);
    // استخراج اسم العميل من الاكسل (او UNKNOWN CLIENT)
    let companyName = getCompany(plate, tracking);
    // استخراج موديل/لون
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let modelColor = vehicleLine.replace(plate, '').trim();
    // استخراج العنوان
    let addressMatch = tracking.match(/Address:\s*(.+)/);
    let address = addressMatch ? addressMatch[1].trim() : "";
    // استخراج خطوط العرض والطول
    let latMatch = tracking.match(/Latitude:\s*([0-9\.\-]+)/);
    let lngMatch = tracking.match(/Longitude:\s*([0-9\.\-]+)/);
    let latitude = latMatch ? latMatch[1] : "";
    let longitude = lngMatch ? lngMatch[1] : "";
    // استخراج السرعة إذا كانت نوع التنبيه overspeed
    let typeText = "";
    if(alertType === "overspeed") {
        let speedMatch = tracking.match(/Speed:\s*([0-9\.]+)\s*kph?/i);
        let speed = speedMatch ? speedMatch[1] : "";
        typeText = speed ? `was speeding ${speed} kph` : "was speeding";
    } else {
        switch (alertType) {
            case "towing": typeText = "was on recovery"; break;
            case "external battery disconnected": typeText = "had the external battery disconnected"; break;
            case "stop for 10 day": typeText = "has stopped for 10 days"; break;
            case "stop in geofence": typeText = "has stopped in geofence"; break;
            default: typeText = "had an event";
        }
    }
    // بناء وصف العربية
    let vehicleDesc = `${companyName} ${plate} ${modelColor}`.replace(/\s+/g, ' ').trim();
    // الرسالة بالنموذج الجديد بدون رموز
    let msg = [
        `Hello, your vehicle has an event,`,
        `${vehicleDesc} ${typeText} (${address})`,
        (latitude && longitude) ? `https://www.google.com/maps?q=${latitude},${longitude}` : '',
        "Clicklife GPS System"
    ].filter(Boolean).join('\n\n');
    document.getElementById('alertOutput').value = msg;
    // إظهار اسم الشركة (العميل) على الصفحة
    let companyField = document.getElementById('companyName');
    companyField.innerHTML = 'Client: <b>' + companyName + '</b>';
    companyField.style.display = 'block';
    document.getElementById('copyBtn').style.display = 'inline-block';
}

function copyAlert() {
    let output = document.getElementById('alertOutput');
    output.select();
    document.execCommand("copy");
    document.getElementById('copyBtn').textContent = "Copied!";
    setTimeout(()=>{document.getElementById('copyBtn').textContent = "Copy Alert";}, 1100);
}

</script>
</body>
</html>
