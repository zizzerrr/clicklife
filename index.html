<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title> Clicklife GPS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(135deg, #22293b 30%, #373e4c 100%);
      color: #f5f6fa;
      overflow-y: auto;
      transition: background 0.5s;
    }
    .container {
      background: #171c24;
      padding: 22px;
      margin: 28px 12px;
      border-radius: 10px;
      width: 100%;
      max-width: 760px;
      box-shadow: 0 2px 18px #22293b70;
      border: 1px solid #252728;
    }
    h2 { color:#34e4a7; margin:0 0 10px 0; font-size:1.6rem; text-align:center; }
    label { display:block; margin-top:12px; color:#b2fff4; font-weight:600; }
    .hint { background:#212a31; padding:8px; margin-top:6px; color:#9fdfe8; border-radius:6px; font-size:0.95rem; }
    textarea, select, input[type="file"] {
      width:100%; padding:8px; margin-top:8px; border-radius:6px; border:1px solid #314047; background:#12171b; color:#d3e5ed;
    }
    .btnRow { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; justify-content:center; }
    button {
      background: linear-gradient(92deg,#34e4a7 32%,#177d70 96%);
      color:#071018; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700;
    }
    #companyName { display:none; margin-top:10px; background:#212a31; padding:8px; border-radius:6px; color:#fff; font-weight:700; }
    .result { margin-top:16px; }
    #alertOutput { min-height:100px; resize:vertical; direction:rtl; text-align:right; }
    #alertOutputHtml { display:none; background:#12171b; padding:10px; border-radius:6px; border:1px solid #314047; color:#dfeff5; direction:rtl; text-align:right; }
    #mapContainer { display:none; margin-top:12px; gap:8px; align-items:center; }
    #mapContainer img { width:100%; max-width:100%; border-radius:6px; border:1px solid #314047; background:#111; cursor:pointer; }
    .mapCaption { background:#212a31; padding:6px 8px; border-radius:6px; color:#dff8ee; font-weight:700; text-align:center; }
    .small { font-size:0.9rem; color:#9fcad4; margin-top:6px; display:block; text-align:center; }
    @media (max-width:700px) {
      h2 { font-size:1.2rem; }
      .container { padding:16px; margin:10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Vehicle Alert Generator — Clicklife GPS</h2>
    <div class="hint">ClicklifeGps</div>

    <label for="txtUpload">Upload TXT File (Vehicle & Client) (NO NEED ANYMORE):</label>
    <input id="txtUpload" type="file" accept=".txt">

    <div id="companyName"></div>

    <label for="trackingData">Tracking Data:</label>
    <textarea id="trackingData" rows="6" placeholder="مثال:&#10;18-56594 NISSAN SUNNY WHITE&#10;Address: شارع ...&#10;Latitude: 25.3750849&#10;Longitude: 55.4391916&#10;Speed: 0 kph"></textarea>

    <label for="alertType">Alert Type:</label>
    <select id="alertType">
      <option value="">-- اختر نوع التنبيه --</option>
      <option value="towing">Towing</option>
      <option value="external battery disconnected">External Battery Disconnected</option>
      <option value="overspeed">Overspeed</option>
      <option value="stop for 10 day">Stop for 10 Day</option>
      <option value="stop in geofence">Stop in Geofence</option>
    </select>

    <div class="btnRow">
      <button onclick="generateAlert('ar')">توليد التنبيه (بالعربية)</button>
      <button onclick="generateAlert('en')">Generate Alert (English)</button>
      <button onclick="copyText()" id="copyTextBtn" style="display:none">نسخ التيكست</button>
      <button onclick="copyImage()" id="copyImageBtn" style="display:none">نسخ الصورة</button>
      <button onclick="downloadMap()" id="downloadBtn" style="display:none">تحميل الخريطة</button>
    </div>

    <div class="result">
      <label>النتيجة:</label>
      <textarea id="alertOutput" readonly></textarea>
      <div id="alertOutputHtml" aria-hidden="false"></div>

      <div id="mapContainer">
        <a id="mapLink" href="#" target="_blank" rel="noopener noreferrer" title="افتح في جوجل مابس">
          <img id="mapImage" src="" alt="Map snapshot">
        </a>
        <div id="mapCaption" class="mapCaption"></div>
      </div>

      <div class="small">الآن يوجد زران منفصلان: "نسخ التيكست" لنسخ النص فقط، و"نسخ الصورة" لنسخ صورة الخريطة فقط. إذا لم يعمل النسخ (بسبب قيود المتصفح)، استخدم "تحميل الخريطة".</div>
    </div>
  </div>

<script>
const LOCATIONIQ_KEY = 'pk.0b0c909e2a0f38bb85908d6cf2499802';
const zoomDefault = 17;
const minWidth = 420;
const maxWidth = 800;

let excelData = {};
if (localStorage.getItem('excelData')) {
  try { excelData = JSON.parse(localStorage.getItem('excelData')) || {}; } catch(e) { excelData = {}; }
}

document.getElementById('txtUpload').addEventListener('change', function(evt){
  const file = evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    const lines = text.split(/\r?\n/);
    excelData = {};
    let headerSkip = false;
    for (let i=0;i<lines.length;i++){
      let line = lines[i].trim();
      if(!line) continue;
      if (!headerSkip) {
        if (line.toLowerCase().includes('vehicle') && line.toLowerCase().includes('client')) {
          headerSkip = true; continue;
        } else headerSkip = true;
      }
      let splitter = (line.indexOf('\t') !== -1) ? '\t' : (line.indexOf(',') !== -1 ? ',' : null);
      let parts = splitter ? line.split(splitter) : line.split(/\s{2,}/);
      let vehicle = (parts[0]||'').replace(/[^A-Za-z0-9\-]/g,'').replace(/\*/g,'').trim().toLowerCase();
      let client = (parts[1]||'').trim();
      if(vehicle) {
        excelData[vehicle] = client || 'UNKNOWN CLIENT';
        excelData[(parts[0]||'').toLowerCase().trim()] = client || 'UNKNOWN CLIENT';
      }
    }
    localStorage.setItem('excelData', JSON.stringify(excelData));
    alert('تم تحميل بيانات TXT: ' + Object.keys(excelData).length + ' مركبة');
  };
  reader.readAsText(file);
});

function getPlate(tracking) {
  let addressIdx = tracking.indexOf("Address:");
  let vehicleLine = (addressIdx !== -1) ? tracking.substring(0,addressIdx).replace(/\n/g,'').trim() : tracking.split('\n')[0];
  let plateMatch = vehicleLine.match(/^(\S+)/);
  let plate = plateMatch ? plateMatch[1].replace(/\*/g,'') : vehicleLine.split(/\s+/)[0] || "";
  return plate.trim();
}

function getCompany(plate, tracking) {
  let normalized = plate.trim().toLowerCase();
  let clean = normalized.replace(/[^a-z0-9]/gi,'');
  if (clean && excelData.hasOwnProperty(clean)) return excelData[clean];
  if (normalized && excelData.hasOwnProperty(normalized)) return excelData[normalized];
  let firstLine = tracking.split('\n')[0].trim().toLowerCase();
  if (firstLine && excelData.hasOwnProperty(firstLine)) return excelData[firstLine];
  for (let k in excelData) {
    if (k.replace(/[^a-z0-9]/gi,'') === clean) return excelData[k];
  }
  return 'UNKNOWN CLIENT';
}

function computeMapSize() {
  const screenW = Math.floor(Math.min(window.innerWidth * 0.88, maxWidth));
  const width = Math.max(minWidth, screenW);
  const height = Math.round(width * 0.66);
  return { width, height };
}

function buildLocationIQUrl(lat, lng, zoom, width, height) {
  return `https://maps.locationiq.com/v3/staticmap?key=${encodeURIComponent(LOCATIONIQ_KEY)}&center=${lat},${lng}&zoom=${zoom}&size=${width}x${height}&markers=${lat},${lng}`;
}

async function generateAlert(lang='ar') {
  const tracking = document.getElementById('trackingData').value || '';
  const alertType = document.getElementById('alertType').value || '';
  if (!tracking || !alertType) { alert('أدخل بيانات التتبع واختر نوع التنبيه'); return; }

  const plate = getPlate(tracking);
  const company = getCompany(plate, tracking);
  const addressMatch = tracking.match(/Address:\s*(.+)/i);
  const address = addressMatch ? addressMatch[1].trim() : '';
  const latMatch = tracking.match(/Latitude:\s*([0-9\.\-]+)/i);
  const lngMatch = tracking.match(/Longitude:\s*([0-9\.\-]+)/i);
  const latitude = latMatch ? latMatch[1] : '';
  const longitude = lngMatch ? lngMatch[1] : '';

  if (!latitude || !longitude) {
    alert('لا يوجد إحداثيات (Latitude/Longitude) في بيانات التتبع. لا يمكن إنشاء صورة الخريطة.');
    return;
  }

  const addressIdx = tracking.indexOf("Address:");
  const firstLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,'').trim() : tracking.split('\n')[0];
  let modelColor = firstLine.replace(new RegExp('^' + escapeRegExp(plate)), '').trim();
  modelColor = modelColor.replace(/\s+/g,' ').trim();

  let typeTextAr = '';
  switch (alertType) {
    case 'overspeed': {
      const s = tracking.match(/Speed:\s*([0-9\.]+)/i); typeTextAr = s ? `تجاوز السرعة (${s[1]} كلم/س)` : 'تجاوز السرعة'; break;
    }
    case 'towing': typeTextAr = 'سحب/استرداد'; break;
    case 'external battery disconnected': typeTextAr = 'فصل البطارية'; break;
    case 'stop for 10 day': typeTextAr = 'توقف لمدة 10 أيام'; break;
    case 'stop in geofence': typeTextAr = 'توقف داخل منطقة جغرافية'; break;
    default: typeTextAr = 'حدث غير محدد';
  }

  const plateAndModel = (plate + (modelColor ? ' ' + modelColor : '')).replace(/\s+/g,' ').trim();
  const googleLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

  const arLines = [
    'مرحبًا،',
    '',
    `يوجد تنبيه لسيارة رقم ${plateAndModel}، حيث تم تلقي تنبيه بـ${typeTextAr} في:`,
    address || '',
    '',
    `رابط الموقع على الخريطة: ${googleLink}`,
    '',
    'فريق عمل كليك لايف جي بي اس'
  ].filter(Boolean);
  const msgArText = arLines.join('\n');

  const typeTextEn = (alertType === 'overspeed') ? ( (tracking.match(/Speed:\s*([0-9\.]+)/i)||[])[1] ? `was speeding ${(tracking.match(/Speed:\s*([0-9\.]+)/i)||[])[1]} kph` : 'was speeding') :
    (alertType === 'towing' ? 'was on recovery' : alertType === 'external battery disconnected' ? 'had the external battery disconnected' :
    alertType === 'stop for 10 day' ? 'has stopped for 10 days' : alertType === 'stop in geofence' ? 'has stopped in geofence' : 'had an event');
  const enLines = [
    'Hello, your vehicle has an event,',
    `${company} ${plateAndModel} ${typeTextEn} (${address})`,
    `https://www.google.com/maps?q=${latitude},${longitude}`,
    'Clicklife GPS System'
  ].filter(Boolean);
  const msgEnText = enLines.join('\n\n');

  const size = computeMapSize();
  const mapUrl = buildLocationIQUrl(latitude, longitude, zoomDefault, size.width, size.height);

  document.getElementById('companyName').innerHTML = 'Client: <b>' + escapeHtml(company) + '</b>';
  document.getElementById('companyName').style.display = 'block';
  document.getElementById('copyTextBtn').style.display = 'inline-block';
  document.getElementById('copyImageBtn').style.display = 'inline-block';
  document.getElementById('downloadBtn').style.display = 'inline-block';

  if (lang === 'ar') {
    document.getElementById('alertOutput').style.display = 'none';
    const outHtml = document.getElementById('alertOutputHtml');
    outHtml.style.display = 'block';
    const html = arLines.map(l => {
      if (l === 'فريق عمل كليك لايف جي بي اس') return '<b>' + escapeHtml(l) + '</b>';
      if (l.startsWith('رابط الموقع على الخريطة:')) {
        return escapeHtml('رابط الموقع على الخريطة: ') + `<a href="${googleLink}" target="_blank" style="color:#9feed0">${googleLink}</a>`;
      }
      return escapeHtml(l);
    }).join('<br>');
    outHtml.innerHTML = html;
    document.getElementById('alertOutput').value = msgArText;
  } else {
    document.getElementById('alertOutputHtml').style.display = 'none';
    const out = document.getElementById('alertOutput');
    out.style.display = 'block';
    out.value = msgEnText;
  }

  const mapImage = document.getElementById('mapImage');
  const mapLinkEl = document.getElementById('mapLink');
  const mapCaption = document.getElementById('mapCaption');

  mapLinkEl.href = googleLink;
  mapCaption.textContent = plateAndModel;

  mapImage.onload = function() {
    document.getElementById('mapContainer').style.display = 'flex';
    mapImage.style.cursor = 'pointer';
    mapImage.onclick = () => window.open(googleLink, '_blank');
  };
  mapImage.onerror = function(e) {
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size.width}' height='${size.height}'><rect fill='#111' width='100%' height='100%'/><text x='50%' y='45%' fill='#fff' font-size='20' text-anchor='middle'>Map not available</text></svg>`;
    mapImage.src = svgToDataUrlBase64(svg);
    mapImage.style.cursor = 'pointer';
    mapImage.onclick = () => window.open(googleLink, '_blank');
    document.getElementById('mapContainer').style.display = 'flex';
  };

  try {
    const resp = await fetch(mapUrl, { mode: 'cors' });
    if (!resp.ok) throw new Error('fetch map failed ' + resp.status);
    const blob = await resp.blob();
    const blobUrl = URL.createObjectURL(blob);
    mapImage._fetchedBlob = blob;
    mapImage.src = blobUrl;
  } catch (err) {
    console.warn('Could not fetch map blob, using direct map URL. Error:', err);
    delete mapImage._fetchedBlob;
    mapImage.src = mapUrl;
  }
}

async function copyText() {
  const outTextarea = document.getElementById('alertOutput');
  const outHtml = document.getElementById('alertOutputHtml');

  let textToCopy = '';
  if (outHtml.style.display === 'block') {
    // alertOutput textarea contains plain text for Arabic, keep using it
    textToCopy = outTextarea.value || outHtml.textContent || outHtml.innerText || '';
  } else {
    textToCopy = outTextarea.value || '';
  }

  if (!textToCopy) { alert('لا يوجد نص للنسخ'); return; }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    try {
      await navigator.clipboard.writeText(textToCopy);
      flashCopyBtn('copyTextBtn');
      alert('تم نسخ التيكست.');
      return;
    } catch (e) {
      console.warn('navigator.clipboard.writeText failed', e);
    }
  }

  // fallback textarea selection
  const ta = document.createElement('textarea');
  ta.value = textToCopy;
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    document.body.removeChild(ta);
    flashCopyBtn('copyTextBtn');
    alert('تم نسخ التيكست (fallback).');
  } catch (e) {
    document.body.removeChild(ta);
    alert('النسخ فشل');
  }
}

async function copyImage() {
  const mapImage = document.getElementById('mapImage');
  if (!mapImage) { alert('لا توجد صورة للنسخ'); return; }

  // Prefer existing fetched blob
  let blob = mapImage._fetchedBlob || null;

  // If no blob, try to fetch current src (could be external URL)
  if (!blob) {
    try {
      const resp = await fetch(mapImage.src, { mode: 'cors' });
      if (resp.ok) {
        blob = await resp.blob();
      }
    } catch (e) {
      console.warn('Fetching image src failed', e);
    }
  }

  if (!blob) {
    alert('تعذّر الحصول على صورة للنسخ. استخدم "تحميل الخريطة" كحل بديل.');
    return;
  }

  // Try clipboard with image only
  if (navigator.clipboard && window.ClipboardItem) {
    try {
      const mime = blob.type || 'image/png';
      const clipboardItemInput = {};
      clipboardItemInput[mime] = blob;
      const clipboardItem = new ClipboardItem(clipboardItemInput);
      await navigator.clipboard.write([clipboardItem]);
      flashCopyBtn('copyImageBtn');
      alert('تم نسخ الصورة إلى الحافظة (إن دعم المتصفح). جرب اللصق في واتساب.');
      return;
    } catch (err) {
      console.warn('clipboard write image failed', err);
    }
  }

  // Fallback: trigger download
  const proceed = confirm('النسخ المباشر للصورة غير مدعوم في متصفحك. هل تريد تنزيل الصورة بدلاً من ذلك؟');
  if (proceed) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'map.png';
    a.click();
    URL.revokeObjectURL(a.href);
  }
}

function downloadMap() {
  const imgEl = document.getElementById('mapImage');
  const blob = imgEl && imgEl._fetchedBlob;
  if (blob) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'map.png';
    a.click();
    URL.revokeObjectURL(a.href);
  } else {
    const link = document.getElementById('mapLink').href;
    window.open(link, '_blank');
  }
}

function flashCopyBtn(id) {
  const btn = document.getElementById(id);
  if (!btn) return;
  const old = btn.textContent;
  btn.textContent = 'تم النسخ!';
  setTimeout(()=>{ btn.textContent = old; }, 1200);
}

function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function escapeHtml(unsafe) { return (unsafe+'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function utf8ToBase64(str) { return btoa(unescape(encodeURIComponent(str))); }
function svgToDataUrlBase64(svg) { return 'data:image/svg+xml;base64,' + utf8ToBase64(svg); }

</script>
</body>
</html>
