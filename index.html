<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Vehicle Alert | Clicklife GPS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Excel & SheetJS Parser CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <style>
    /* ...كل التنسيقات القديمة كما هي... */
    /* أضف تنسيق بسيط لزر رفع الإكسل وخانة اسم الشركة */
    #excelUpload {
      display:block;
      margin:16px 0 6px 0;
      background:rgba(255,255,255,0.18);
      color:#2366b1;
      border-radius:10px;
      font-size:1rem;
      border:none;
      outline:none;
      padding:8px;
      font-family:'Rubik', Arial, sans-serif;
    }
    #companyName {
      display: none;
      font-size:1.09rem;
      margin-bottom:7px;
      color:#e7e8fc;
      background:rgba(35,132,235,0.13);
      padding:4px 12px;
      border-radius:7px;
      font-weight:700;
      font-family:'Rubik', Arial, sans-serif;
    }
  </style>
</head>
<body>
  <!-- GPS/Map video background -->
  <video class="bg-video" autoplay loop muted playsinline>
    <source src="https://assets.mixkit.co/videos/preview/mixkit-navigation-map-on-a-gps-2187-large.mp4" type="video/mp4">
    <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=900&q=80" alt="gps background">
  </video>
  <div class="overlay"></div>

  <div class="container">
    <h2>Clicklife GPS Alert</h2>
    <div class="subtitle">Generate a professional vehicle alert in seconds.</div>

    <!-- Excel Upload Field -->
    <label for="excelUpload">Upload Excel File (Plate & Company):</label>
    <input type="file" id="excelUpload" accept=".xls,.xlsx">
    <span class="hint">رفع ملف إكسل يحتوي على رقم العربية واسم الشركة</span>
    <div id="companyName"></div>

    <label for="trackingData">Tracking Data:</label>
    <span class="hint">Paste the vehicle tracking data from your system below.</span>
    <textarea id="trackingData" placeholder="Example:&#10;B-71093 Attrage Gray&#10;Address: New Industrial, Ajman, UAE&#10;Speed: 105 kph"></textarea>
    <label for="alertType">Alert Type:</label>
    <select id="alertType">
      <option value="">-- Select alert type --</option>
      <option value="towing">Towing</option>
      <option value="external battery disconnected">External Battery Disconnected</option>
      <option value="overspeed">Overspeed</option>
      <option value="stop for 10 day">Stop for 10 Day</option>
      <option value="stop in geofence">Stop in Geofence</option>
    </select>
    <button onclick="generateAlert()"><i class="fa-solid fa-bolt"></i> Generate Alert</button>
    <button onclick="copyAlert()" id="copyBtn"><i class="fa-solid fa-copy"></i> Copy Alert</button>
    <div class="resultRow">
      <label for="alertOutput">Result:</label>
      <textarea id="alertOutput" readonly></textarea>
    </div>
  </div>
<script>
// تخزين معلومات الإكسل (Plate: Company)
let excelData = {};

document.getElementById('excelUpload').addEventListener('change', function(evt){
  let file = evt.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(e){
    let data = new Uint8Array(e.target.result);
    let workbook = XLSX.read(data, {type: 'array'});
    let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    let sheetJson = XLSX.utils.sheet_to_json(firstSheet, {header:1});
    // توقع أن أول صف هو العناوين: [Plate, Company]
    let plateIdx = -1, companyIdx = -1;
    if (!sheetJson.length) return alert("Empty Excel file");
    // البحث عن الأعمدة بالعناوين Plate وCompany
    sheetJson[0].forEach((col, idx)=>{
      if(typeof col === 'string') {
        if(col.toLowerCase().includes('plate')) plateIdx = idx;
        if(col.toLowerCase().includes('company')) companyIdx = idx;
      }
    });
    if(plateIdx === -1 || companyIdx === -1)
      return alert("Excel must have columns 'Plate' and 'Company'");
    // بناء قاموس البيانات
    excelData = {};
    for(let i=1; i<sheetJson.length; ++i){
      let row = sheetJson[i];
      // تأكد أن الصف به بيانات
      let plateVal = row[plateIdx];
      let companyVal = row[companyIdx];
      if(plateVal)
        excelData[String(plateVal).trim()] = String(companyVal || '').trim() || 'UNKNOWN COMPANY';
    }
    alert('Excel data loaded: ' + Object.keys(excelData).length + ' vehicle(s)');
  };
  reader.readAsArrayBuffer(file);
});

// وظيفة استخراج رقم العربية من trackingData
function getPlate(tracking) {
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let plateMatch = vehicleLine.match(/^[^\s]+/);
    let plate = plateMatch ? plateMatch[0] : vehicleLine.split(/\s+/)[0] || "";
    return plate.trim();
}

// استخراج اسم الشركة من بيانات الإكسل
function getCompany(plate) {
    // ابحث بالضبط أو تجاه حالة الأحرف
    let normalizedPlate = plate.trim();
    // جرب التطابق المباشر
    if(excelData.hasOwnProperty(normalizedPlate)) return excelData[normalizedPlate];
    // جرب التطابق بغض النظر عن الأحرف الصغيرة/كبيرة
    for (let key in excelData) {
      if (key.toLowerCase() === normalizedPlate.toLowerCase()) return excelData[key];
    }
    return 'UNKNOWN COMPANY';
}

function generateAlert() {
    let tracking = document.getElementById('trackingData').value;
    let alertType = document.getElementById('alertType').value;
    if (!tracking || !alertType) { alert('Please enter tracking data and select alert type.'); return; }
    // استخراج رقم العربية
    let plate = getPlate(tracking);
    // استخراج اسم الشركة من الاكسل (او UNKNOWN COMPANY)
    let companyName = getCompany(plate);

    // استخراج موديل/لون
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let modelColor = vehicleLine.replace(plate, '').trim();

    // استخراج العنوان
    let addressMatch = tracking.match(/Address:\s*(.+)/);
    let address = addressMatch ? addressMatch[1].trim() : "";

    // استخراج خطوط العرض والطول
    let latMatch = tracking.match(/Latitude:\s*([0-9\.\-]+)/);
    let lngMatch = tracking.match(/Longitude:\s*([0-9\.\-]+)/);
    let latitude = latMatch ? latMatch[1] : "";
    let longitude = lngMatch ? lngMatch[1] : "";

    // استخراج السرعة إذا كانت نوع التنبيه overspeed
    let typeText = "";
    if(alertType === "overspeed") {
        let speedMatch = tracking.match(/Speed:\s*([0-9\.]+)\s*kph?/i);
        let speed = speedMatch ? speedMatch[1] : "";
        typeText = speed ? `was speeding ${speed} kph` : "was speeding";
    } else {
        switch (alertType) {
            case "towing": typeText = "was on recovery"; break;
            case "external battery disconnected": typeText = "had the external battery disconnected"; break;
            case "stop for 10 day": typeText = "has stopped for 10 days"; break;
            case "stop in geofence": typeText = "has stopped in geofence"; break;
            default: typeText = "had an event";
        }
    }

    // بناء وصف العربية
    let vehicleDesc = `${companyName} ${plate} ${modelColor}`.replace(/\s+/g, ' ').trim();

    // الرسالة بالنموذج الجديد
    let msg = [
        `Hello, your vehicle has an event,`,
        `${vehicleDesc} ${typeText} (${address})`,
        (latitude && longitude) ? `https://www.google.com/maps?q=${latitude},${longitude}&t=m&hl=en` : '',
        "Clicklife GPS System"
    ].filter(Boolean).join('\n\n');
    document.getElementById('alertOutput').value = msg;

    // إظهار اسم الشركة على الصفحة
    let companyField = document.getElementById('companyName');
    companyField.innerHTML = 'Company: <b>' + companyName + '</b>';
    companyField.style.display = 'block';

    document.getElementById('copyBtn').style.display = 'inline-block';
}

function copyAlert() {
    let output = document.getElementById('alertOutput');
    output.select();
    document.execCommand("copy");
    document.getElementById('copyBtn').textContent = "✅ Copied!";
    setTimeout(()=>{document.getElementById('copyBtn').innerHTML = '<i class=\"fa-solid fa-copy\"></i> Copy Alert';}, 1200);
}
</script>
</body>
</html>
