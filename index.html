<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†Ø¨Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª - Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ù†</title>
    <style>
        body { font-family: Tahoma, Arial, sans-serif; background:#f7f7fa; }
        .container { width:95%; max-width:620px; margin:40px auto; background:#fff; border-radius:8px; box-shadow:0 3px 20px #0002; padding:24px;}
        textarea,input,select,button{width:100%;margin:8px 0;padding:8px;border-radius:6px;border:1px solid #bbb;}
        textarea{height:90px;}
        #alertOutput{height:130px;}
        .row{margin-bottom:15px;}
        .label{font-weight:bold;}
        .hint{color:#888; font-size:0.96em;}
        .status{margin:9px 0;}
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸš— Ù…Ù†Ø¨Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (Ø¥Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†)</h2>
    <div class="row">
        <div class="label">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª:</div>
        <div class="hint">ÙƒÙ„ Ø³Ø·Ø±: Ø±Ù‚Ù… Ø¹Ø±Ø¨ÙŠØ©,Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©<br>Ø£Ùˆ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ (ØªØ¸Ù„Ù„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ† ÙˆØªØ¹Ù…Ù„ Ù†Ø³Ø®-Ù„ØµÙ‚ Ù‡Ù†Ø§)<br>Ù…Ø«Ø§Ù„:<br>0009193* Corolla White,Alkobaisi Motors<br>104599 Kicks white [tab] AA CAR</div>
        <textarea id="vehiclesData" placeholder="Ø±Ù‚Ù… Ø¹Ø±Ø¨ÙŠØ©,Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ copy Ù…Ù† Excel"></textarea>
        <button onclick="saveCars()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <div class="status" id="statusCars"></div>
    </div>
    <div class="row">
        <div class="label">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹:</div>
        <textarea id="trackingData" placeholder="Ø£Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù‡Ù†Ø§"></textarea>
    </div>
    <div class="row">
        <div class="label">Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡:</div>
        <select id="alertType">
            <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ --</option>
            <option value="towing">Towing</option>
            <option value="external battery disconnected">External Battery Disconnected</option>
            <option value="overspeed">Overspeed</option>
            <option value="stop for 10 day">Stop for 10 Day</option>
            <option value="stop in geofence">Stop in Geofence</option>
        </select>
    </div>
    <button onclick="generateAlert()">âœ¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
    <button onclick="copyAlert()" id="copyBtn" style="display:none">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
    <div class="row">
        <div class="label">Ø§Ù„Ù†ØªÙŠØ¬Ø©:</div>
        <textarea id="alertOutput" readonly></textarea>
    </div>
</div>
<script>
let carMap = {};

function normalizePlate(plate) {
    return String(plate)
        .replace(/[\s\-\*,.\/\\\u200E\u200F]+/g, '')
        .replace(/[^\w\d]/g, '')
        .toLowerCase().trim();
}

// Ù…Ø±ÙˆÙ†Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ø£ÙŠ Ø¬Ø¯ÙˆÙ„ (csv, tab, space, Ø¥Ù„Ø®)
function saveCars() {
    carMap = {};
    let lines = document.getElementById('vehiclesData').value.split('\n');
    let added = 0;
    for (let line of lines) {
        if (!line.trim()) continue;
        let sep = line.includes('\t') ? '\t' : (line.includes(',') ? ',' : ' ');
        let s = line.split(sep);
        // Ù„Ùˆ ÙÙŠÙ‡ Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ù…ÙˆØ¯ØŒ Ø®Ø° Ø£ÙˆÙ„ Ø§ØªÙ†ÙŠÙ† Ø¨Ø³
        if (s.length >=2 && s[0].trim() && s[1].trim()) {
            let plate = normalizePlate(s[0]);
            let company = s.slice(1).join(" ").replace(/^[,\s]+/, '').trim();
            carMap[plate] = company;
            added++;
        }
    }
    document.getElementById('statusCars').textContent = `ØªÙ… Ø­ÙØ¸ ${added} Ø³ÙŠØ§Ø±Ø©.`;
    localStorage.setItem('carMapManual', JSON.stringify(carMap));
}

window.onload = function() {
    let d = localStorage.getItem('carMapManual');
    if (d) { carMap = JSON.parse(d); document.getElementById('statusCars').textContent = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.'; }
};

function generateAlert() {
    let tracking = document.getElementById('trackingData').value;
    let alertType = document.getElementById('alertType').value;
    if (!tracking || !alertType) { alert('Ø§ÙƒØªØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡'); return; }
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø© Ù‚Ø¨Ù„ Address ØºØ§Ù„Ø¨Ù‹Ø§)
    let addressIdx = tracking.indexOf("Address:");
    let vehicleLine = (addressIdx !== -1) ? tracking.substring(0, addressIdx).replace(/\n/g,"").trim() : tracking.split('\n')[0];
    let plateMatch = vehicleLine.match(/^[^\s]+/);
    let plate = plateMatch ? plateMatch[0] : vehicleLine.split(/\s+/)[0] || "";
    let modelColor = vehicleLine.replace(plate, '').trim();
    let plateNorm = normalizePlate(plate);
    // Ù…Ø±ÙˆÙ†Ø©: Ù„Ùˆ Ù…Ø´ Ù„Ø§Ù‚ÙŠ ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„ØŒ Ø¯ÙˆØ± ØªØ·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ
    let clientName = carMap[plateNorm] || "";
    if (!clientName) {
        for (let k in carMap) {
            if (plateNorm.includes(k) || k.includes(plateNorm)) {
                clientName = carMap[k];
                break;
            }
        }
    }
    if (!clientName) clientName = "UNKNOWN COMPANY";
    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let addressMatch = tracking.match(/Address:\s*(.+)/);
    let address = addressMatch ? addressMatch[1].trim() : "";
    let latMatch = tracking.match(/Latitude:\s*([0-9\.\-]+)/);
    let lngMatch = tracking.match(/Longitude:\s*([0-9\.\-]+)/);
    let latitude = latMatch ? latMatch[1] : "";
    let longitude = lngMatch ? lngMatch[1] : "";
    let vehicleDesc = clientName + ' ' + plate + (modelColor ? ' ' + modelColor : '');
    let typeText = "";
    switch (alertType) {
        case "towing": typeText = "is on recovery"; break;
        case "external battery disconnected": typeText = "has external battery disconnected"; break;
        case "overspeed": typeText = "is overspeeding"; break;
        case "stop for 10 day": typeText = "has stopped for 10 days"; break;
        case "stop in geofence": typeText = "has stopped in geofence"; break;
        default: typeText = "has an event";
    }
    let msg = [
        `Hello, your vehicle has an event,`,
        `${vehicleDesc} ${typeText} (${address})`,
        (latitude && longitude) ? `https://www.google.com/maps?q=${latitude},${longitude}&t=m&hl=en` : '',
        "Clicklife GPS System"
    ].filter(Boolean).join('\n\n');
    document.getElementById('alertOutput').value = msg;
    document.getElementById('copyBtn').style.display = 'inline-block';
}

function copyAlert() {
    let output = document.getElementById('alertOutput');
    output.select();
    document.execCommand("copy");
    document.getElementById('copyBtn').textContent = "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!";
    setTimeout(()=>{document.getElementById('copyBtn').textContent = "ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡";}, 1200);
}
</script>
</body>
</html>
